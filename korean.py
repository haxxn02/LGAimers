import os
import json
import time
from openai import OpenAI
from tqdm import tqdm
from dotenv import load_dotenv # [추가된 부분]

# 1. .env 파일 로드
load_dotenv()

# 2. 환경변수에서 토큰 가져오기
FRIENDLI_TOKEN = os.getenv("FRIENDLI_TOKEN")

# [안전장치] 토큰이 잘 불러와졌는지 확인
if not FRIENDLI_TOKEN:
    print("❌ 오류: .env 파일을 찾을 수 없거나 토큰이 없습니다.")
    print("test.py와 같은 폴더에 .env 파일이 있는지 확인해주세요.")
    exit()

client = OpenAI(
    api_key=FRIENDLI_TOKEN,
    base_url="https://api.friendli.ai/serverless/v1"
)

# 모델 ID
TEACHER_MODEL_ID = "LGAI-EXAONE/K-EXAONE-236B-A23B"

# 질문 리스트 (최소 500개 목표!)
seed_prompts = [
    "조선시대 붕당 정치가 형성되고 전개되는 과정을 정치 구조 변화와 함께 설명해줘.",
    "훈구와 사림의 대립이 조선 전기 정치 운영에 어떤 영향을 미쳤는지 분석해줘.",
    "조선 후기 탕평책이 등장한 배경과 그 한계를 정치적 관점에서 설명해줘.",
    "임진왜란 이후 조선의 군사 제도와 재정 구조가 어떻게 변화했는지 설명해줘.",
    "대동법이 기존 공납 제도의 문제를 어떻게 해결했는지 논리적으로 설명해줘.",
    "영조와 정조의 개혁 정치가 공통점과 차이점을 보이는 이유를 분석해줘.",
    "조선 후기 실학이 등장하게 된 사회·경제적 배경을 설명해줘.",
    "실학자 유형별(경세치용·이용후생·실사구시) 사상의 차이를 비교해줘.",
    "세도 정치가 조선 사회 전반에 미친 영향을 정치·경제적으로 설명해줘.",
    "흥선대원군의 개혁 정책이 지닌 성과와 한계를 종합적으로 분석해줘.",
    "강화도 조약이 조선의 주권과 외교 질서에 미친 영향을 설명해줘.",
    "개화 정책을 둘러싼 조선 내부의 정치 세력 갈등을 설명해줘.",
    "갑신정변과 갑오개혁의 목표와 성격 차이를 비교 분석해줘.",
    "일제의 식민지 통치 방식이 시기별로 어떻게 변화했는지 설명해줘.",
    "3·1 운동이 국내외 독립운동에 미친 영향을 분석해줘.",
    "대한민국 정부 수립 과정에서 발생한 정치적 쟁점을 설명해줘.",
    "4·19 혁명이 한국 민주주의 발전에 갖는 역사적 의미를 논리적으로 설명해줘.",
    "군사 정권 시기의 경제 성장 정책이 지닌 긍정적·부정적 측면을 분석해줘.",
    "훈민정음 창제 원리를 음운 체계와 문자 설계 측면에서 설명해줘.",
    "중세 국어와 현대 국어의 문법적 차이를 예시와 함께 설명해줘.",
    "국어의 높임 표현 체계가 사회적 관계를 어떻게 반영하는지 분석해줘.",
    "표준어 규정과 방언의 관계를 언어 정책 관점에서 설명해줘.",
    "한글 맞춤법과 표준 발음법이 분리되어 존재하는 이유를 설명해줘.",
    "담화 맥락이 문장 의미 해석에 미치는 영향을 설명해줘.",
    "비유와 상징이 문학 작품의 주제 형성에 기여하는 방식을 설명해줘.",
    "고전 소설과 현대 소설의 서사 구조 차이를 비교 분석해줘.",
    "시적 화자와 작가의 관점이 반드시 일치하지 않는 이유를 설명해줘.",
    "서술자의 시점 변화가 독자의 해석에 미치는 영향을 분석해줘.",
    "설득적 글쓰기에서 논증 구조가 중요한 이유를 설명해줘.",
    "주장·근거·반론 구조를 갖춘 글이 설득력을 가지는 이유를 설명해줘.",
    "언어의 사회적 기능을 의사소통 이론 관점에서 설명해줘.",
    "은유와 환유의 차이를 인지적 관점에서 설명해줘.",
    "문학 작품에서 열린 결말이 가지는 효과를 설명해줘.",
    "칸트의 정언명령이 의무 윤리의 핵심 원리인 이유를 설명해줘.",
    "공리주의가 결과를 중시하는 윤리 이론인 이유를 논리적으로 설명해줘.",
    "의무론과 공리주의가 동일한 상황에서 다른 결론에 도달하는 이유를 설명해줘.",
    "아리스토텔레스의 덕 윤리가 습관을 강조하는 이유를 설명해줘.",
    "행복 개념이 윤리 이론별로 어떻게 다르게 정의되는지 비교해줘.",
    "자유의지 논쟁에서 결정론과 자유의지론의 핵심 쟁점을 설명해줘.",
    "사회계약론에서 국가 권력의 정당성이 어떻게 설명되는지 분석해줘.",
    "롤즈의 정의론에서 무지의 베일이 필요한 이유를 설명해줘.",
    "윤리적 상대주의의 장점과 문제점을 비판적으로 분석해줘.",
    "현대 기술 사회에서 책임 윤리가 강조되는 이유를 설명해줘.",
    "인공지능 의사결정에 윤리적 기준이 필요한 이유를 논리적으로 설명해줘.",
    "생명 윤리 문제에서 개인의 자율성과 사회적 가치가 충돌하는 이유를 설명해줘.",
    "환경 윤리가 인간 중심 윤리를 비판하는 근거를 설명해줘.",
    "정의와 평등이 항상 동일한 개념이 아닌 이유를 설명해줘.",
    "도덕 판단에서 감정과 이성이 각각 어떤 역할을 하는지 분석해줘.",

    "조선 전기 과전법이 국가 재정과 관료 통제에 어떤 기능을 했는지 설명해줘.",
    "조선 후기 상품 화폐 경제의 발달이 신분 질서에 미친 영향을 분석해줘.",
    "향약과 서원이 지방 사회 운영에서 수행한 역할을 비교해줘.",
    "조선 시대 왕권과 신권의 관계가 시기별로 어떻게 달라졌는지 설명해줘.",
    "통신사 파견이 조선과 일본의 외교 관계에서 가지는 의미를 설명해줘.",
    "북벌론과 북학론이 등장한 배경과 지향점의 차이를 분석해줘.",
    "병자호란 이후 조선의 대외 인식이 어떻게 변화했는지 설명해줘.",
    "조선 후기 농민 봉기가 단순한 경제 문제를 넘어선 이유를 분석해줘.",
    "동학 사상이 기존 유교 질서에 대해 어떤 비판을 제기했는지 설명해줘.",
    "동학 농민 운동이 근대 민중 운동으로 평가받는 이유를 설명해줘.",
    "대한제국 수립이 갖는 역사적 의의와 한계를 분석해줘.",
    "을사늑약이 국제법적 관점에서 왜 문제였는지 설명해줘.",
    "무단 통치와 문화 통치의 통치 전략 차이를 비교해줘.",
    "대한민국 임시정부의 노선 변화가 독립운동 전략에 미친 영향을 설명해줘.",
    "광복 이후 좌우 대립이 심화된 구조적 원인을 설명해줘.",
    "한국 전쟁이 한반도 정치 구조에 남긴 장기적 영향을 분석해줘.",
    "산업화 과정에서 농촌 사회가 겪은 변화와 문제를 설명해줘.",
    "민주화 이후 시민 사회의 역할이 확대된 이유를 설명해줘.",
    "언어 기호의 자의성이 국어 의미 체계에 미치는 영향을 설명해줘.",
    "형태소 분석이 문법 이해에 중요한 이유를 예시와 함께 설명해줘.",
    "어휘의 다의성이 의사소통에서 혼란을 일으킬 수 있는 이유를 설명해줘.",
    "문법 규칙이 실제 언어 사용과 항상 일치하지 않는 이유를 설명해줘.",
    "담화 표지가 글의 논리 구조를 드러내는 방식에 대해 설명해줘.",
    "설명문과 논설문의 목적과 구성 방식 차이를 비교해줘.",
    "고전 시가에서 자연 이미지가 자주 사용되는 이유를 설명해줘.",
    "현대 시에서 일상어 사용이 가지는 미학적 효과를 설명해줘.",
    "문학 장르 구분이 절대적이지 않은 이유를 설명해줘.",
    "패러디가 원작에 대한 비판적 해석으로 기능하는 이유를 설명해줘.",
    "독자의 해석이 작품 의미 형성에 기여하는 이유를 설명해줘.",
    "맥락에 따라 동일한 문장이 다른 의미를 갖는 이유를 설명해줘.",
    "국어 교육에서 문법 교육이 필요한 이유를 비판적으로 설명해줘.",
    "글쓰기에서 개요 작성이 논리 전개에 중요한 이유를 설명해줘.",
    "정보 전달 글과 감성 전달 글의 표현 전략 차이를 비교해줘.",
    "칸트 윤리학에서 행위의 결과보다 동기가 중요한 이유를 설명해줘.",
    "공리주의에서 소수의 희생이 정당화될 수 있는 논리를 분석해줘.",
    "덕 윤리가 규칙 중심 윤리와 구별되는 핵심 특징을 설명해줘.",
    "윤리적 딜레마 상황에서 일관된 판단이 어려운 이유를 설명해줘.",
    "자율성과 타율성이 도덕 행위 평가에서 중요한 이유를 설명해줘.",
    "도덕 규범이 시대와 사회에 따라 변화하는 이유를 설명해줘.",
    "법과 도덕이 항상 일치하지 않는 이유를 사례 중심으로 설명해줘.",
    "양심의 역할이 윤리적 판단에서 중요한 이유를 설명해줘.",
    "책임 개념이 결과 책임과 의도 책임으로 구분되는 이유를 설명해줘.",
    "정의로운 분배가 능력 중심과 필요 중심으로 나뉘는 이유를 설명해줘.",
    "인권 개념이 보편적 가치로 인정받게 된 철학적 배경을 설명해줘.",
    "차별이 윤리적으로 문제가 되는 이유를 규범 윤리 관점에서 설명해줘.",
    "기술 발전이 기존 윤리 이론으로 설명되기 어려운 이유를 설명해줘.",
    "동물 윤리가 인간 중심 윤리에 도전하는 논리를 설명해줘.",
    "공공의 이익과 개인의 권리가 충돌할 때 발생하는 윤리적 쟁점을 설명해줘.",


]

output_file = "exaone_korean_dataset.jsonl"
print(f"🚀 데이터 생성을 시작합니다... (모델: {TEACHER_MODEL_ID})")

successful_count = 0
with open(output_file, "a", encoding="utf-8") as f:
    for prompt in tqdm(seed_prompts):
        
        for attempt in range(5): 
            try:
                response = client.chat.completions.create(
                    model=TEACHER_MODEL_ID,
                    messages=[
                        {"role": "system", "content": "You are EXAONE, a helpful AI assistant."},
                        {"role": "user", "content": prompt}
                    ],
                    max_tokens=1024,
                    # temperature=0.7 (삭제됨)
                )
                
                answer = response.choices[0].message.content
                
                data_point = {
                    "instruction": prompt,
                    "output": answer
                }
                f.write(json.dumps(data_point, ensure_ascii=False) + "\n")
                f.flush()
                successful_count += 1
                
                time.sleep(2) 
                break 
                
            except Exception as e:
                error_msg = str(e)
                if "429" in error_msg or "Rate limit" in error_msg:
                    print(f"\n⏳ 너무 빨라요! 10초 대기 중... (시도 {attempt+1}/5)")
                    time.sleep(10)
                elif "422" in error_msg:
                    print(f"\n❌ 설정 오류: {e}")
                    break
                else:
                    print(f"\n❌ 알 수 없는 오류: {e}")
                    time.sleep(5)

print(f"\n✅ 완료! 총 {successful_count}개의 데이터가 '{output_file}'에 저장되었습니다.")